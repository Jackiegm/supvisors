<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/doc_style.css">
    <link rel="stylesheet" href="css/menu.css">
    <title>Supervisors: A Control System for Distributed Applications</title>
</head>

<body>
    <div id="body_block">

        <div id="left_side">
            <header>
                <h1><a href="https://github.com/julien6387/supervisors" target="_blank">Supervisors</a></h1>
    			<p class="version">0.1beta</p>
    		</header>

			<nav>
    		    <ul>
	 			    <li><a href="index.html">Introduction</a></li>
                    <li><a href="xml-rpc-api.html">XML-RPC API</a></li>
                    <li><a href="supervisorctl-api.html">supervisorctl API</a></li>
                    <li><a href="event-interface.html" class="active">Event Interface</a><ul>
               		    <li><a href="#protocol">Protocol</a></li>
               		    <li><a href="#msg-header">Message header</a></li>
               		    <li><a href="#msg-data">Message data</a></li>
                        <li><a href="#clients">Event Clients</a><ul>
                            <li><a href="#py-client">Python Client</a></li>
                            <li><a href="#java-client">JAVA Client</a></li>
                            <li><a href="#cpp-client">C++ Client</a></li>
                        </ul></li>
               	    </ul></li>
                    <li><a href="dashboard.html">HTTP Dashboard</a></li>
                    <li><a href="design.html">Software Design</a></li>
                </ul>
			</nav>

			<footer>
				<p>Contact: <a href="mailto:julien.6387.dev@gmail.com">Julien Le Cl&eacute;ach</a></p>
				<p id="copyright">&copy; Copyright 2016 Julien LE CLEACH</p>
			</footer>
		</div>

		<div id="right_side">
			<header>
				<h2>Documentation &raquo; Event Interface</h2>
			</header>

			<section id="doc-contents">
				<h2 id="protocol">Protocol</h2>
				<p>The Supervisors Event Interface relies on a <a href="http://zeromq.org" class="extLink">ZeroMQ</a> socket.<br />
				To receive the Supervisors events, the client application must configure a socket with a <code>SUBSCRIBE</code> pattern and connect it on localhost using the <a href="index.html#supervisors-section" class="intLink">event_port</a> defined in the supervisors section of the Supervisor configuration file.</p>
				<p>Supervisors publishes the events in multi-parts messages.</p>

				<h2 id="msg-header">Message header</h2>
				<p>The first part is a header that consists in an unicode string. This header identifies the type of the event, defined as follows in the supervisors.utils module:</p>
				<pre><code class='python'>SUPERVISORS_STATUS_HEADER = u'supervisors'
ADDRESS_STATUS_HEADER = u'address'
APPLICATION_STATUS_HEADER = u'application'
PROCESS_STATUS_HEADER = u'process'</code></pre>

                <p>ZeroMQ makes it possible to filter the messages received on the client side by subcribing to a part of them.<br />
                To receive all messages, just subscribe using an empty string.<br />
                For example, the following lines in python configure the ZMQ socket so as to receive only the <code class="className">SupervisorsStatus</code> and <code class="className">ProcessStatus</code> events:</p>
				<pre><code class='python'>socket.setsockopt(zmq.SUBSCRIBE, SUPERVISORS_STATUS_HEADER.encode('utf-8'))
socket.setsockopt(zmq.SUBSCRIBE, PROCESS_STATUS_HEADER.encode('utf-8'))</code></pre>


				<h2 id="msg-data">Message data</h2>
                <p>The second part of the message is a dictionary serialized in JSON. Of course, the contents depends on the message type.</p>

				<h3>Supervisors status</h3>
				<table>
					<caption>Supervisors Status Dictionary</caption>
					<tr><th>Key</th><th>Value</th></tr>
					<tr><td><code>'statecode'</code></td><td>The state of Supervisors, in [0;3].</td></tr>
					<tr><td><code>'statename'</code></td><td>The state of Supervisors, among { <code>'INITIALIZATION'</code>, <code>'DEPLOYMENT'</code>, <code>'OPERATION'</code>, <code>'CONCILIATION'</code> }.</td></tr>
				</table>

				<h3>Address status</h3>
				<table>
					<caption>Address Status Dictionary</caption>
					<tr><th>Key</th><th>Value</th></tr>
					<tr><td><code>'address_name'</code></td><td>Name of the address.</td></tr>
					<tr><td><code>'statecode'</code></td><td>State of the address, in [0;4].</td></tr>
					<tr><td><code>'state'name</code></td><td>State of the address, among { <code>'UNKNOWN'</code>, <code>'RUNNING'</code>, <code>'SILENT'</code>, <code>'ISOLATING'</code>, <code>'ISOLATED'</code> }.</td></tr>
					<tr><td><code>'remote_time'</code></td><td>Date of the last TICK event received from this address.</td></tr>
					<tr><td><code>'local_time'</code></td><td>Local date of the last TICK event received from this address.</td></tr>
					<tr><td><code>'loading'</code></td><td>Sum of the expected loading of the processes running on the address.</td></tr>
				</table>

				<h3>Application status</h3>
				<table>
					<caption>Application Status Dictionary</caption>
					<tr><th>Key</th><th>Value</th></tr>
					<tr><td><code>'application_name'</code></td><td>Name of the application.</td></tr>
					<tr><td><code>'statecode'</code></td><td>State of the application, in [0;4].</td></tr>
					<tr><td><code>'statename'</code></td><td>State of the application, among { <code>'STOPPED'</code>, <code>'STARTING'</code>, <code>'RUNNING'</code>, <code>'STOPPING'</code> }.</td></tr>
					<tr><td><code>'major_failure'</code></td><td>True if the application is running and at least one required process is not started.</td></tr>
					<tr><td><code>'minor_failure'</code></td><td>True if the application is running and at least one optional (not required) process is not started.</td></tr>
				</table>

				<h3>Process status</h3>
				<table>
					<caption>Process Status Dictionary</caption>
					<tr><th>Key</th><th>Value</th></tr>
					<tr><td><code>'application_name'</code></td><td>Name of the application.</td></tr>
					<tr><td><code>'process_name'</code></td><td>Name of the process.</td></tr>
					<tr><td><code>'statecode'</code></td><td>State of the process, in {0, 10, 20, 30, 40, 100, 200, 1000}.</td></tr>
					<tr><td><code>'statename'</code></td><td>State of the process, among { <code>'STOPPED'</code>, <code>'STARTING'</code>, <code>'RUNNING'</code>, <code>'BACKOFF'</code>, <code>'STOPPING'</code>, <code>'EXITED'</code>, <code>'FATAL'</code>, <code>'UNKNOWN'</code> }.</td></tr>
					<tr><td><code>'expected_exit'</code></td><td>True if the exit status is expected (only when state is <code>'EXITED'</code>).</td></tr>
					<tr><td><code>'last_event_time'</code></td><td>Date of the last process event received for this process, regardless of the origin (Supervisor instance).</td></tr>
					<tr><td><code>'addresses'</code></td><td>List of addresses where the process is running.</td></tr>
				</table>


				<h2 id="clients">Event Clients</h2>
				<p>This section explains how to use receive the Supervisors Events from a Python, JAVA or C++ client.</p>

				<h3 id="py-client">Python Client</h3>
                <p>The <code>SupervisorsEventInterface</code> of the <code>supervisors.client.subscriber</code> module is designed to receive the Supervisors events from the local Supervisors instance.<br />
                The default behaviour is to print the messages received. For any other behaviour, just specialize the methods <code>on_xxx_status</code> of the class <code>SupervisorsEventInterface</code>.<br />
                No additional third party is required.</p>

                <pre><code class="python">from supervisors.client.subscriber import *

# create the subscriber thread
subscriber = SupervisorsEventInterface(create_zmq_context(), port, create_logger())
# subscribe to all messages
subscriber.subscribe_all()
# start the thread
subscriber.start()</code></pre>

				<h3 id="java-client">JAVA Client</h3>
                <p>Supervisors provides a JAVA client in the <code>client/java</code> directory of the Supervisors installation directory.<br />
                The <code>SupervisorsEventSubscriber</code> of the <code>org.supervisors.event</code> package is designed to receive the Supervisors events from the local Supervisors instance.<br />
                A <code>SupervisorsEventListener</code> with a specialization of the methods <code>onXxxStatus</code> must be attached to the <code>SupervisorsEventSubscriber</code> instance to receive the notifications.<br />
                It requires the following additional dependencies:</p>
                <ul>
                    <li><a href="https://github.com/zeromq/jeromq" class="extLink">JeroMQ</a>.</li>
                    <li><a href="https://github.com/stleary/JSON-java" class="extLink">JSON-java</a>.</li>
                </ul>
                <p>The binary JAR of <code>JeroMQ 0.3.6</code> is available in the <a href="https://mvnrepository.com/artifact/org.zeromq/jeromq/0.3.6" class="extLink">MAVEN repository</a>.</p>
                <p>The binary JAR of <code>JSON-java 20160810</code> is available in the <a href="https://mvnrepository.com/artifact/org.json/json/20160810" class="extLink">MAVEN repository</a>.</p>

                <pre><code class="JAVA">import org.supervisors.event.*;

// create ZeroMQ context
Context context = ZMQ.context(1);

// create and configure the subscriber
SupervisorsEventSubscriber subscriber = new SupervisorsEventSubscriber(60002, context);
subscriber.subscribeToAll();
subscriber.setListener(new SupervisorsEventListener() {

    @Override
    public void onSupervisorsStatus(final SupervisorsStatus status) {
        System.out.println(status);
    }

    @Override
    public void onAddressStatus(final SupervisorsAddressInfo status) {
        System.out.println(status);
    }

    @Override
    public void onApplicationStatus(final SupervisorsApplicationInfo status) {
        System.out.println(status);
    }

    @Override
    public void onProcessStatus(final SupervisorsProcessInfo status) {
        System.out.println(status);
    }
});

// start subscriber in thread
Thread t = new Thread(subscriber);
t.start();</code></pre>

                <h3 id="cpp-client">C++ Client</h3>
                <p><span class="not-implemented-yet"></span></p>

            </section>

		</div>
	</div>
</body>
</html>

